---
title: "Flattening CP Partner Grant Areas"
author: "Clarissa Boyajian"
date: "11/9/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(tidyverse)
library(sf)
library(tmap)
```

# Creating City Plants Partner Grant Areas


## Creating Los Angeles Outline
```{r Create LA outlines}
la_cd_outline <- st_read(dsn = "data_general/LA_City_Council_Districts_(Adopted_2012).kml")

la_city_outline <- st_read(dsn = "data_general/City_Boundary.kml") %>% 
  mutate(Name = "City of LA Outline") %>% 
  select("Name", "geometry")


tmap_mode("view")

tm_shape(la_cd_outline) +
  tm_polygons(col = "Name")

tm_shape(la_city_outline) +
  tm_polygons()
```


## Creating KYCC Grant Areas
```{r KYCC grants}
# Read in full partner area
kycc_area <- st_read(dsn = "grant_area_data/kycc.kml") %>% 
  select("Name", "geometry")


# Create CalFire-Jefferson area
kycc_calfire_jefferson_rough <- st_read(dsn = "grant_area_data/KYCC_calfire-jefferson.kml") %>% 
  select("Name", "geometry")

kycc_calfire_jefferson <- st_intersection(kycc_area, kycc_calfire_jefferson_rough) %>% 
  select("Name", "geometry") %>% 
  mutate(Name = "KYCC_CalFire-Jefferson")

# Remove CalFire-Jefferson from KYCC area
kycc_area_smaller <- st_difference(kycc_area, kycc_calfire_jefferson_rough) %>% 
  select("Name", "geometry")


# Create CalFire-SLA area
kycc_calfire_sla_rough <- st_read(dsn = "grant_area_data/KYCC_calfire-sla.kml") %>% 
  select("Name", "geometry")

kycc_calfire_sla <- st_intersection(kycc_area_smaller, kycc_calfire_sla_rough) %>% 
  select("Name", "geometry") %>% 
  mutate(Name = "KYCC_CalFire-SLA")

# Remove CalFire-SLA area from KYCC area
kycc_area_smaller <- st_difference(kycc_area_smaller, kycc_calfire_sla_rough) %>% 
  select("Name", "geometry")


# Create CalFire-Ambassadors area
kycc_calfire_ambassadors_rough <- st_read(dsn = "grant_area_data/KYCC_calfire-ambassadors.kml") %>% 
  select("Name", "geometry")

kycc_calfire_ambassadors <- st_intersection(kycc_area_smaller, kycc_calfire_ambassadors_rough) %>% 
  select("Name", "geometry") %>% 
  mutate(Name = "KYCC_CalFire-Ambassador")

# Remove CalFire-Ambassadors area from KYCC area
kycc_area_smaller <- st_difference(kycc_area_smaller, kycc_calfire_ambassadors_rough) %>% 
  select("Name", "geometry")


# Remove and create CalFire-Density grant
kycc_calfire_density_rough <- st_read(dsn = "grant_area_data/KYCC_calfire-density.kml") %>% 
  select("Name", "geometry")

kycc_calfire_density <- st_intersection(kycc_area_smaller, kycc_calfire_density_rough) %>% 
  select("Name", "geometry") %>% 
  mutate(Name = "KYCC_CalFire-Density")

kycc_area_smaller <- st_difference(kycc_area_smaller, kycc_calfire_density_rough) %>% 
  select("Name", "geometry")


# Combine all () grants
kycc_grants <- rbind(kycc_calfire_jefferson, kycc_calfire_sla, kycc_calfire_ambassadors, kycc_calfire_density)


# Map check
tm_shape(kycc_grants) +
  tm_borders(col = NA) +
  tm_fill(col = "Name") +
  tm_layout(legend.outside = TRUE, legend.outside.position = c("left", "middle")) +
  tm_shape(kycc_area) +
  tm_borders(col = "darkred", alpha = 0.75) +
  tm_fill(col = "grey", alpha = 0.5)
```

#### Save to SHP and KML Files (NOTE: have to run manually)
```{r Save KYCC grants to SHP and KML, eval=FALSE}
# Save KYCC grants to shp and kml
st_write(kycc_grants, "grant_area_flattened/KYCC_Grants.shp", append = FALSE)

st_write(kycc_grants, "grant_area_flattened/KYCC_Grants.kml", append = FALSE)
```


## Creating TP Grant Areas
```{r TP grants}
# Read in full partner area
tp_area <- st_read(dsn = "grant_area_data/tp.kml") %>% 
  select("Name", "geometry") %>% 
  mutate(Name = "TreePeople_Watts-Rising")


# Create TP Watts Rising Area
tp_grants <- tp_area


# Map check
tm_shape(tp_grants) +
  tm_borders(col = NA) +
  tm_fill(col = "Name") +
  tm_layout(legend.outside = TRUE, legend.outside.position = c("left", "middle")) +
  tm_shape(tp_area) +
  tm_borders(col = "darkred", alpha = 0.75) +
  tm_fill(col = "grey", alpha = 0.5)
```

#### Save to SHP and KML Files (NOTE: have to run manually)
```{r Save TP grants to SHP and KML, eval=FALSE}
# Save TP grants to shp and kml
st_write(tp_grants, "grant_area_flattened/TP_Grants.shp", append = FALSE)

st_write(tp_grants, "grant_area_flattened/TP_Grants.kml", append = FALSE)
```


## Creating LACC Grants Areas
```{r LACC_Valley}
# Read in full partner area
lacc_valley_area <- st_read(dsn = "grant_area_data/lacc_valley.kml") %>% 
  select("Name", "geometry")

# Create TCC Project area
lacc_valley_tcc_rough <- st_read(dsn = "grant_area_data/lacc-valley_tcc-project.kml")

lacc_valley_tcc <- st_intersection(lacc_valley_area, lacc_valley_tcc_rough) %>% 
  select("Name", "geometry") %>% 
  mutate(Name = "LACC-Valley_TCC-project")

# Combine all () grants
lacc_valley_grants <- lacc_valley_tcc


# Map check
tm_shape(lacc_valley_grants) +
  tm_borders(col = NA) +
  tm_fill(col = "Name") +
  tm_layout(legend.outside = TRUE, legend.outside.position = c("left", "middle")) +
  tm_shape(lacc_valley_area) +
  tm_borders(col = "darkred", alpha = 0.75) +
  tm_fill(col = "grey", alpha = 0.5)
```

#### Save to SHP and KML Files (NOTE: have to run manually)
```{r Save LACC_Valley grants to SHP and KML, eval=FALSE}
# Save LACC_Valley grants to shp and kml
st_write(lacc_valley_grants, "grant_area_flattened/LACC_Valley_Grants.shp", append = FALSE)

st_write(lacc_valley_grants, "grant_area_flattened/LACC_Valley_Grants.kml", append = FALSE)
```


## Creating HLABT Grant Areas
```{r HLABT}
# Read in full partner area
hlabt_area <- st_read(dsn = "grant_area_data/hlabt.kml") %>% 
  select("Name", "geometry")


# Create CalFire-CD13 area
hlabt_cf13_rough <- st_read(dsn = "grant_area_data/HLABT_CD13.kml") %>% 
  select("Name", "geometry")

hlabt_cf13 <- st_intersection(hlabt_area, hlabt_cf13_rough) %>% 
  select("Name", "geometry") %>% 
  mutate(Name = "HLABT_CalFire-cd13")

# Remove CalFire-Jefferson from KYCC area
hlabt_area_smaller <- st_difference(hlabt_area, hlabt_cf13_rough) %>% 
  select("Name", "geometry")


# Create CalFire-CDs 2/6/7 area
hlabt_cf267_rough <- st_read(dsn = "grant_area_data/HLABT_CD267.kml") %>% 
  select("Name", "geometry")

hlabt_cf267 <- st_intersection(hlabt_area_smaller, hlabt_cf267_rough) %>% 
  select("Name", "geometry") %>% 
  mutate(Name = "HLABT_CalFire-CDs2/6/7")

# Remove CalFire-CD2-6-7 from HLABT area
hlabt_area_smaller <- st_difference(hlabt_area_smaller, hlabt_cf267_rough) %>% 
  select("Name", "geometry") %>% 
  mutate(Name = "HLABT_CalFire-CDs2/4/6/7")




# Create CalFire-CDs 2/4/6/7 area
hlabt_cf2467 <- hlabt_area_smaller


# Combine all HLABT grants
hlabt_grants <- rbind(hlabt_cf267, hlabt_cf2467, hlabt_cf13)


# Map check
tm_shape(hlabt_grants) +
  tm_borders(col = NA) +
  tm_fill(col = "Name") +
  tm_layout(legend.outside = TRUE, legend.outside.position = c("left", "middle")) +
  tm_shape(hlabt_area) +
  tm_borders(col = "darkred", alpha = 0.75) +
  tm_fill(col = "grey", alpha = 0.5)
```

#### Save to SHP and KML Files (NOTE: have to run manually)
```{r Save HLABT grants to SHP and KML, eval=FALSE}
# Save HLABT grants to shp and kml
st_write(hlabt_grants, "grant_area_flattened/HLABT_Grants.shp", append = FALSE)

st_write(hlabt_grants, "grant_area_flattened/HLABT_Grants.kml", append = FALSE)
```


## Creating NET area and LASAN Boyle Heights area
```{r}
# Read in full NET partner area
net_area <- st_read(dsn = "grant_area_data/net.kml") %>% 
  select("Name", "geometry")


# Create NET_Ramona-Gardens
net_ramona_gardens_rough <- st_read(dsn = "grant_area_data/NET_ramona-gardens.kml")

net_ramona_gardens <- st_intersection(net_area, net_ramona_gardens_rough) %>% 
  select("Name", "geometry") %>% 
  mutate(Name = "NET_Ramona-gardens")

# Remove NET_Ramona-gardens from NET area
net_area_smaller <- st_difference(net_area, net_ramona_gardens_rough)


# Create NET_Buchanan-ES
net_buchanan_rough <- st_read(dsn = "grant_area_data/NET_buchanan-es.kml")

net_buchanan <- st_intersection(net_area_smaller, net_buchanan_rough) %>% 
  select("Name", "geometry") %>% 
  mutate(Name = "NET_Buchanan-ES")

# Remove NET_Buchanan-ES from NET area
net_area_smaller <- st_difference(net_area_smaller, net_buchanan_rough)


# Create NET_Ascot-Hills
net_ascot_hills_rough <- st_read(dsn = "grant_area_data/NET_ascot-hills.kml")

net_ascot_hills <- st_intersection(net_area_smaller, net_ascot_hills_rough) %>% 
  select("Name", "geometry") %>% 
  mutate(Name = "NET_Ascot-Hills")

# Remove NET_Ascot-Hills from NET area
net_area_smaller <- st_difference(net_area_smaller, net_ascot_hills_rough)


#Create NET_SCLA-Greening area
net_scla_rough <- st_read(dsn = "grant_area_data/NET_scla-greening.kml")

net_scla <- st_intersection(net_area_smaller, net_scla_rough) %>% 
  select("Name", "geometry") %>% 
  mutate(Name = "NET_SCLA-Greening")

# Remove LASAN Boyle Heights from NET area
net_area_smaller <- st_difference(net_area_smaller, net_scla_rough)


#Create NET_Watts-Rising area
net_watts_rough <- st_read(dsn = "grant_area_data/NET_watts-rising.kml")

net_watts <- st_intersection(net_area_smaller, net_watts_rough) %>% 
  select("Name", "geometry") %>% 
  mutate(Name = "NET_Watts-Rising")

# Remove LASAN Boyle Heights from NET area
net_area_smaller <- st_difference(net_area_smaller, net_watts_rough)



#Create LASAN Boyle Heights area
lasan_boyle_heights_rough <- st_read(dsn = "grant_area_data/LASAN_boyle-heights.kml")

lasan_boyle_heights <- st_intersection(net_area_smaller, lasan_boyle_heights_rough) %>% 
  select("Name", "geometry") %>% 
  mutate(Name = "LASAN_Boyle-Heights")

# Remove LASAN Boyle Heights from NET area
net_area_smaller <- st_difference(net_area_smaller, lasan_boyle_heights_rough)


# Create NET CalFire area
net_calfire <- net_area_smaller %>% 
  select("Name", "geometry") %>% 
  mutate(Name = "NET_CalFire")


# Combine all NET grants
net_grants <- rbind(net_ascot_hills, net_buchanan, net_ramona_gardens, net_scla, net_watts, net_calfire)


# Map check
tm_shape(net_area) +
  tm_polygons(col = "grey", alpha = 0.5) +
  tm_shape(net_grants) +
  tm_borders(col = "darkred") +
  tm_fill(col = "Name") +
  tm_shape(lasan_boyle_heights) +
  tm_borders(col = "darkred") +
  tm_fill(col = "blue") +
  tm_layout(legend.outside = TRUE, legend.outside.position = c("left", "middle"))
```

#### Save to SHP and KML Files (NOTE: have to run manually)
```{r Save NET grants to SHP and KML, eval=FALSE}
# Save NET grants to shp and kml
st_write(net_grants, "grant_area_flattened/NET_Grants.shp", append = FALSE)

st_write(net_grants, "grant_area_flattened/NET_Grants.kml", append = FALSE)
```


## Combine all non-profit partner grants
```{r}
all_np_grants <- rbind(kycc_grants, tp_grants, hlabt_grants, net_grants, lacc_valley_tcc)

all_np_grants_unioned <- st_union(st_buffer(all_np_grants, dist = 5)) %>% 
  st_make_valid()

tm_shape(all_np_grants) +
  tm_polygons(col = "Name")
```

#### Save to SHP and KML Files (NOTE: have to run manually)
```{r Save all grants to SHP and KML, eval=FALSE}
# Save all grants to shp and kml
st_write(all_np_grants, "grant_area_flattened/City-Plants_NP-Partner_Grants.shp", append = FALSE)

st_write(all_np_grants, "grant_area_flattened/City-Plants_NP-Partner_Grants.kml", append = FALSE)
```



## Create LASAN_GGLA grant area
```{r LASAN}
# Read in LASAN_GGLA
lasan_ggla_rough <- st_read(dsn = "data_general/LASAN_GGLA_minus-kycc.kml") %>% 
  select("Name", "geometry") %>% 
  mutate(Name = "LASAN-GGLA")


#Create full LASAN_GGLA area
lasan_ggla_buffered <- st_buffer(lasan_ggla_rough, dist = 5)

lasan_ggla_unioned <- st_union(lasan_ggla_buffered) %>% 
  st_make_valid()

# Save to KML Files
st_write(lasan_ggla_unioned, "grant_area_data/LASAN_GGLA.kml", append = FALSE)
st_write(all_np_grants_unioned, "grant_area_data/ALL_NP_Grants.kml", append = FALSE)


# Read back in saved KML file
lasan_ggla_gmaps <- st_read("grant_area_data/LASAN_GGLA.kml")

all_np_grants_gmaps <- st_read("grant_area_data/ALL_NP_Grants.kml") %>%
  select("Name", "geometry") %>% 
  mutate(Name = "All_NP-grants")


# Create non-overlapping LASAN_GGLA area
lasan_ggla_minus_city <- st_intersection(lasan_ggla_gmaps, la_city_outline) %>%
  select("Name", "geometry") %>% 
  mutate(Name = "LASAN-GGLA")

lasan_ggla_smaller <- st_difference(lasan_ggla_minus_city, all_np_grants_gmaps) %>% ### it is breaking here
  select("Name", "geometry") %>% 
  mutate(Name = "LASAN-GGLA")

lasan_ggla <- st_difference(lasan_ggla_smaller, lasan_boyle_heights_rough) %>% 
  select("Name", "geometry") %>% 
  mutate(Name = "LASAN-GGLA")
```



## Create LASAN_TREEandSHADE grant area
```{r}
# Read in LASAN_TREE
lasan_tree_rough <- st_read(dsn = "data_general/LASAN-Shade_LA_and_TREEmendous.kml") %>% 
  select("Name", "geometry") %>% 
  mutate(Name = "LASAN-TREE")


#Create full LASAN_TREE area
lasan_tree_buffered <- st_buffer(lasan_tree_rough, dist = 5)

lasan_tree_unioned <- st_union(lasan_tree_buffered) %>% 
  st_make_valid()

# Save to KML File
st_write(lasan_tree_unioned, "grant_area_data/LASAN_TREEandSHADE.kml", append = FALSE)

# Read saved LASAN_TREE KML file
lasan_tree_gmaps <- st_read("grant_area_data/LASAN_TREEandSHADE.kml")

lasan_tree_minus_city <- st_intersection(lasan_tree_gmaps, la_city_outline)

lasan_tree_smaller <- st_difference(lasan_tree_minus_city, all_np_grants) %>%
  st_make_valid() %>% 
  select("Name", "geometry") %>% 
  mutate(Name = "LASAN-TREEandSHADE")

lasan_tree_smaller <- st_difference(lasan_tree_smaller, lasan_ggla_gmaps) %>% 
  select("Name", "geometry") %>% 
  mutate(Name = "LASAN-TREEandSHADE")

lasan_tree <- st_difference(lasan_tree_smaller, lasan_boyle_heights_rough) %>% 
  select("Name", "geometry") %>% 
  mutate(Name = "LASAN-TREEandSHADE")
```


```{r}
tm_shape(lasan_ggla_minus_city) +
  tm_borders(col = "red")
```



## Combining All Grants
```{r All grants combined}
all_partner_grants <- rbind(all_np_grants, lasan_boyle_heights, lasan_ggla, lasan_tree)
```

```{r}
tm_shape(lasan_ggla) +
  tm_polygons(col = "grey") +
  tm_shape(lasan_tree_smaller) +
  tm_borders(col = "red") +
  tm_shape(net_grants) +
  tm_fill(col = "lightblue")
```



## Mapping all grant areas
```{r Map all grants}
tm_shape(la_city_outline) +
  tm_polygons(col = "lightgrey", alpha = 0.5) +
  tm_shape(all_partner_grants) +
  tm_borders(col = "black", alpha = 0.5) +
  tm_fill(col = "Name")

```












